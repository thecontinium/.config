#!/usr/bin/env bash
set -euo pipefail

# -----------------------------
# Usage: setup-notebook-env [ENV_NAME] [PY_VERSION]
# Example: setup-notebook-env notebook-base 3.12.6
# -----------------------------

ENV_NAME="${1:-notebook-base}" # default name if not passed
PY_VERSION="${2:-3.14.0}"      # default Python version
REQ_FILE="${XDG_CONFIG_HOME:-$HOME/.config}/pyenv/bin/requirements.txt"

# Ensure pyenv is initialized for this script
if command -v pyenv >/dev/null 2>&1; then
  eval "$(pyenv init -)"
  if command -v pyenv-virtualenv-init >/dev/null 2>&1; then
    eval "$(pyenv virtualenv-init -)"
  fi
else
  echo "‚ùå pyenv not found in PATH. Install pyenv first."
  exit 1
fi

# Check if the target environment already exists
if pyenv virtualenvs --bare | grep "^$ENV_NAME$"; then
  echo "‚ÑπÔ∏è Environment $ENV_NAME already exists. Skipping setup."
  exit 0
fi

# Deactivate current virtualenv if any
if [[ -n "${PYENV_VERSION:-}" ]]; then
  echo "‚ö†Ô∏è Deactivating current pyenv virtualenv ..."
  pyenv deactivate
fi

echo "üì¶ Setting up environment: $ENV_NAME ($PY_VERSION)"
echo "üìÑ Using requirements: $REQ_FILE"

# Install Python if missing
pyenv install -s "$PY_VERSION"

# Create virtualenv if it doesn't exist
if ! pyenv virtualenvs --bare | grep -q "^${ENV_NAME}$"; then
  echo "üêç Creating virtualenv $ENV_NAME..."
  pyenv virtualenv "$PY_VERSION" "$ENV_NAME"
fi

# Activate the environment
pyenv activate "$ENV_NAME"

# Install requirements
if [[ ! -f "$REQ_FILE" ]]; then
  echo "‚ö†Ô∏è Requirements file not found at $REQ_FILE"
  exit 1
fi

pip install -U pip setuptools wheel -q
pip install -r "$REQ_FILE" -q

echo "‚úÖ Environment $ENV_NAME is ready!"
